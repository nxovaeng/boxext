name: TVBox CI

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      max_sites:
        description: '最大站点数量'
        required: false
        default: '100'
      min_score:
        description: '最低质量分数'
        required: false
        default: '30'
  # 定时触发（每周三 UTC 20:00 = 北京时间周四 04:00）
  schedule:
    - cron: '0 20 * * 3'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        # 安装 mkdocs 及主题
        pip install mkdocs mkdocs-material pymdown-extensions

    - name: Build documentation
      run: |
        mkdocs build --strict
        echo "=== Docs build contents ==="
        ls -la docs_build/

    - name: Validate scan and build
      run: |
        # 使用智能筛选构建，支持手动输入参数
        MAX_SITES="${{ github.event.inputs.max_sites || '100' }}"
        MIN_SCORE="${{ github.event.inputs.min_score || '30' }}"
        echo "构建参数: max_sites=$MAX_SITES, min_score=$MIN_SCORE"
        python unified_manager.py build --output smart_output --max-sites $MAX_SITES --min-score $MIN_SCORE

    - name: Prepare publish directory
      run: |
        mkdir -p publish
        # 复制 smart_output/merged 如果存在
        if [ -d "smart_output/merged" ]; then
          cp -r smart_output/merged/* publish/
        fi
        # 复制 custom 目录内容
        if [ -d "custom" ]; then
          cp -r custom/* publish/
        fi
        # 复制 mkdocs 构建的文档
        if [ -d "docs_build" ]; then
          mkdir -p publish/docs
          cp -r docs_build/* publish/docs/
        fi
        # 确保 .nojekyll 存在
        touch publish/.nojekyll
        # 列出发布内容
        echo "=== Publish directory contents ==="
        ls -la publish/
        echo "=== Docs directory ==="
        ls -la publish/docs/ || echo "No docs directory"

    - name: Check publish directory
      id: check_publish
      run: |
        if [ -d "publish" ] && [ "$(ls -A publish)" ]; then
          echo "has_content=true" >> $GITHUB_OUTPUT
        else
          echo "has_content=false" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && steps.check_publish.outputs.has_content == 'true'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./publish
        publish_branch: gh-pages
        force_orphan: true
        cname: box.zro.qzz.io
